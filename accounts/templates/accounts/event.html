{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event List</title>
    <link rel="stylesheet" href="{% static 'css/event_style.css' %}">

    <style>
        /* Disable animations while searching */
        .no-anim, .no-anim * {
            animation: none !important;
            transition: none !important;
        }
    </style>
</head>

<body>

    <!-- ðŸ”™ Logout Button -->
    <div class="back-btn-container fade-up delay-1">
        <a href="{% url 'accounts:confirmlogout_organizer' %}" class="back-btn">Logout</a>
    </div>

    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
        <script>
            setTimeout(() => {
                document.querySelectorAll('.message').forEach(msg => {
                    msg.classList.add('fade-out');
                    setTimeout(() => msg.remove(), 600);
                });
            }, 5000);
        </script>
    {% endif %}

    <div class="container">

        <!-- Page Header -->
        <header class="fade-up delay-1">
            <h1 class="fade-up delay-1">Upcoming Events</h1>
            <a href="{% url 'accounts:create_event' %}" class="btn-create fade-up delay-2">+ Create Event</a>
        </header>

        <!-- Search Bar -->
        <div class="search-bar-container fade-up delay-2">
            <input type="text" id="searchBar" placeholder="Search events..." class="search-input fade-up delay-2">
        </div>

        <!-- Event Grid -->
        <div class="event-grid" id="eventGrid">
            {% for event in events %}
                <div class="event-card">
                    <h2>{{ event.event_name }}</h2>
                    <p><strong>Venue:</strong> {{ event.event_venue }}</p>
                    <p><strong>Category:</strong> {{ event.event_category }}</p>
                    <p><strong>Date:</strong> {{ event.event_date|date:"M d, Y" }}</p>
                    <p><strong>Time In:</strong> {{ event.event_time_in|time:"g:i A" }}</p>
                    <p><strong>Time Out:</strong> {{ event.event_time_out|time:"g:i A" }}</p>
                    <p><strong>Ticket Price:</strong> â‚±{{ event.ticket_price|intcomma }}</p>
                    <p><strong>Ticket Limit:</strong> {{ event.ticket_limit }}</p>
                    <p class="desc"><strong>Description:</strong> {{ event.event_description }}</p>

                    <div class="actions">
                        <a href="{% url 'accounts:edit_event' event.id %}" class="edit">Edit</a>

                        <!-- ONE confirmation only -->
                        <a href="{% url 'accounts:delete_event' event.id %}" class="delete"
                           onclick="return confirm('Are you sure you want to delete this event?');">
                            Delete
                        </a>
                    </div>
                </div>
            {% empty %}
                <p class="no-events fade-up delay-2">No events created yet.</p>
            {% endfor %}
        </div>
    </div>

<!-- ======================== -->
<!--   LIVE SEARCH SCRIPT     -->
<!-- ======================== -->

<script>
const searchInput = document.getElementById("searchBar");
const grid = document.getElementById("eventGrid");

if (searchInput) {
    searchInput.addEventListener("input", function () {
        const q = this.value.trim();

        grid.classList.add("no-anim");

        fetch("/accounts/live-search-organizer-events/?q=" + encodeURIComponent(q))
            .then(resp => resp.json())
            .then(data => {
                grid.innerHTML = "";

                if (!data.events || data.events.length === 0) {
                    grid.innerHTML = `<p class="no-events">No events found.</p>`;
                    setTimeout(() => grid.classList.remove("no-anim"), 150);
                    return;
                }

                data.events.forEach(e => {

                    grid.innerHTML += `
                        <div class="event-card">
                            <h2>${escapeHtml(e.event_name)}</h2>
                            <p><strong>Venue:</strong> ${escapeHtml(e.event_venue)}</p>
                            <p><strong>Category:</strong> ${escapeHtml(e.event_category)}</p>
                            <p><strong>Date:</strong> ${escapeHtml(e.event_date)}</p>
                            <p><strong>Time In:</strong> ${escapeHtml(e.event_time_in)}</p>
                            <p><strong>Time Out:</strong> ${escapeHtml(e.event_time_out)}</p>
                            <p><strong>Ticket Price:</strong> â‚±${escapeHtml(e.ticket_price)}</p>
                            <p><strong>Ticket Limit:</strong> ${escapeHtml(String(e.ticket_limit))}</p>
                            <p class="desc"><strong>Description:</strong> ${escapeHtml(e.event_description)}</p>

                            <div class="actions">
                                <a href="${e.edit_url}" class="edit">Edit</a>

                                <!-- DO NOT add confirmation here (already added above) -->
                                <a href="${e.delete_url}" class="delete">Delete</a>
                            </div>
                        </div>
                    `;
                });

                setTimeout(() => {
                    grid.classList.remove("no-anim");
                }, 150);
            })
            .catch(err => console.error("live search error:", err));
    });
}

function escapeHtml(str) {
    if (!str) return "";
    return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
}
</script>

</body>
</html>
