{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event List</title>
    <link rel="stylesheet" href="{% static 'css/event_style.css' %}">

    <style>
        .no-anim, .no-anim * {
            animation: none !important;
            transition: none !important;
        }

        .event-card.expired {
            background: #ffe5e5 !important;
            border-left: 6px solid #ff1a1a !important;
            opacity: 0.9;
        }

        .expired-badge {
            display: inline-block;
            background: #ff1a1a;
            color: white;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .available-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>

    <div class="back-btn-container fade-up delay-1">
        <a href="{% url 'accounts:confirmlogout_organizer' %}" class="back-btn">Logout</a>
    </div>

    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
        <script>
            setTimeout(() => {
                document.querySelectorAll('.message').forEach(msg => {
                    msg.classList.add('fade-out');
                    setTimeout(() => msg.remove(), 600);
                });
            }, 5000);
        </script>
    {% endif %}

    <div class="container">

        <header class="fade-up delay-1">
            <h1 class="fade-up delay-1">Your Events</h1>
            <a href="{% url 'accounts:create_event' %}" class="btn-create fade-up delay-2">+ Create Event</a>
        </header>

        <div class="search-bar-container fade-up delay-2">
            <input type="text" id="searchBar" placeholder="Search events..." class="search-input fade-up delay-2">
        </div>

        <div class="event-grid" id="eventGrid">
            {% for event in events %}
                <div class="event-card {% if event.is_expired %}expired{% endif %}">

                    {% if event.is_expired %}
                        <div class="expired-badge">Expired!</div>
                    {% else %}
                        <div class="available-badge">Available!</div>
                    {% endif %}

                    <h2>{{ event.event_name }}</h2>
                    <p><strong>Venue:</strong> {{ event.event_venue }}</p>
                    <p><strong>Category:</strong> {{ event.event_category }}</p>
                    <p><strong>Date:</strong> {{ event.event_date|date:"M d, Y" }}</p>

                    <!-- ⭐ FIXED TIME FORMAT (non-search) -->
                    <p><strong>Time In:</strong> {{ event.event_time_in|time:"h:i a" }}</p>
                    <p><strong>Time Out:</strong> {{ event.event_time_out|time:"h:i a" }}</p>

                    <p><strong>Ticket Price:</strong> ₱{{ event.ticket_price|intcomma }}</p>
                    <p><strong>Ticket Limit:</strong> {{ event.ticket_limit }}</p>
                    <p class="desc"><strong>Description:</strong> {{ event.event_description }}</p>

                    <div class="actions">
                        <a href="{% url 'accounts:edit_event' event.id %}" class="edit">Edit</a>

                        <a href="{% url 'accounts:delete_event' event.id %}" class="delete">
                            Delete
                        </a>
                    </div>
                </div>
            {% empty %}
                <p class="no-events fade-up delay-2">No events created yet.</p>
            {% endfor %}
        </div>
    </div>

<!-- ======================== -->
<!--   LIVE SEARCH SCRIPT     -->
<!-- ======================== -->

<script>
const searchInput = document.getElementById("searchBar");
const grid = document.getElementById("eventGrid");

if (searchInput) {
    searchInput.addEventListener("input", function () {
        const q = this.value.trim();

        grid.classList.add("no-anim");

        fetch("/accounts/live-search-organizer-events/?q=" + encodeURIComponent(q))
            .then(resp => resp.json())
            .then(data => {
                grid.innerHTML = "";

                if (!data.events || data.events.length === 0) {
                    grid.innerHTML = `<p class="no-events">No events found.</p>`;
                    setTimeout(() => grid.classList.remove("no-anim"), 150);
                    return;
                }

                data.events.forEach(e => {

                    // Expiration check
                    let isExpired = false;
                    const now = new Date();
                    const eventEnd = new Date(`${e.event_date} ${e.event_time_out}`);
                    if (now > eventEnd) isExpired = true;

                    // ⭐ Date Format: "Nov 28, 2026"
                    const d = new Date(e.event_date);
                    const formattedDate = d.toLocaleDateString("en-US", {
                        month: "short",
                        day: "numeric",
                        year: "numeric"
                    });

                    // ⭐ Convert time to lowercase "pm"
                    const timeIn = e.event_time_in.toLowerCase();
                    const timeOut = e.event_time_out.toLowerCase();

                    grid.innerHTML += `
                        <div class="event-card ${isExpired ? "expired" : ""}">

                            ${isExpired 
                                ? `<div class="expired-badge">Expired!</div>`
                                : `<div class="available-badge">Available!</div>`}

                            <h2>${escapeHtml(e.event_name)}</h2>
                            <p><strong>Venue:</strong> ${escapeHtml(e.event_venue)}</p>
                            <p><strong>Category:</strong> ${escapeHtml(e.event_category)}</p>

                            <p><strong>Date:</strong> ${formattedDate}</p>

                            <p><strong>Time In:</strong> ${timeIn}</p>
                            <p><strong>Time Out:</strong> ${timeOut}</p>

                            <p><strong>Ticket Price:</strong> ₱${escapeHtml(e.ticket_price)}</p>
                            <p><strong>Ticket Limit:</strong> ${escapeHtml(String(e.ticket_limit))}</p>
                            <p class="desc"><strong>Description:</strong> ${escapeHtml(e.event_description)}</p>

                            <div class="actions">
                                <a href="${e.edit_url}" class="edit">Edit</a>
                                <a href="${e.delete_url}" class="delete">Delete</a>
                            </div>
                        </div>
                    `;
                });

                setTimeout(() => grid.classList.remove("no-anim"), 150);
            })
            .catch(err => console.error("live search error:", err));
    });
}

function escapeHtml(str) {
    if (!str) return "";
    return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll("\"", "&quot;")
        .replaceAll("'", "&#039;");
}
</script>

</body>
</html>
