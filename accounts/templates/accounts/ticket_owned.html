{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tickets</title>
    <link rel="stylesheet" href="{% static 'css/ticket_owned_styles.css' %}">
</head>
<body>

<!-- HEADER with Search -->
<div class="header">
    <h1>üéüÔ∏è My Tickets</h1>
    <a href="{% url 'accounts:home' %}" class="back-btn">‚¨Ö Back to Home</a>

    <!-- Search bar -->
    <div class="search-bar">
        <form method="get" action="">
            <input 
                type="text" 
                id="search-input" 
                name="q" 
                placeholder="Search your tickets..." 
                autocomplete="off"
            >
            <button type="submit">üîç</button>
        </form>
    </div>
</div>

{% if messages %}
<div class="messages">
    {% for message in messages %}
        <div class="message {{ message.tags }}">{{ message }}</div>
    {% endfor %}
</div>

<script>
setTimeout(() => {
    document.querySelectorAll('.message').forEach(msg => {
        msg.classList.add('fade-out');
        setTimeout(() => msg.remove(), 600);
    });
}, 5000);
</script>
{% endif %}

{% if tickets %}
<div class="ticket-grid" id="ticket-grid">
    {% for ticket in tickets %}
        <div class="ticket-card {% if ticket.event.is_deleted %}deleted{% endif %}">

            <h3>{{ ticket.event.event_name }}</h3>

            {% if ticket.event.is_deleted and ticket.is_expired %}
                <div class="deleted-text">This event deleted & expired!</div>

            {% elif ticket.event.is_deleted %}
                <div class="deleted-text">This event has been deleted</div>

            {% elif ticket.is_expired %}
                <div class="expired-text">‚ùå Ticket has been expired!</div>

            {% elif ticket.event.is_edited %}
                <div class="edited-warning">‚ö† This event has been modified</div>

            {% else %}
                <div class="blank-status-bar">This event is available</div>
            {% endif %}

            <p><strong>Venue:</strong> {{ ticket.event.event_venue }}</p>

            <p><strong>Date:</strong> {{ ticket.event.event_date }}</p>

            <p><strong>Time:</strong> 
                {{ ticket.event.event_time_in|time:"h:i A" }} - 
                {{ ticket.event.event_time_out|time:"h:i A" }}
            </p>

            <p><strong>Price:</strong> ‚Ç±{{ ticket.event.ticket_price }}</p>

            <!-- ‚≠ê FINAL CORRECT BUTTON LOGIC ‚≠ê -->
            {% if ticket.is_expired %}
                <!-- Expired = delete only -->
                <button type="button" 
                        class="delete-btn open-delete-modal expired-btn" 
                        data-ticket-id="{{ ticket.id }}">
                    Delete
                </button>

            {% elif ticket.event.is_deleted %}
                <!-- Deleted event = refund -->
                <button type="button" 
                        class="delete-btn open-delete-modal" 
                        data-ticket-id="{{ ticket.id }}">
                    Delete & Refund
                </button>

            {% else %}
                <!-- Event active + ticket active -->
                <button type="button" 
                        class="delete-btn ticket-in-use-btn" 
                        disabled>
                    Ticket In Use!
                </button>
            {% endif %}

        </div>
    {% endfor %}
</div>
{% else %}
<p class="no-tickets">You don‚Äôt own any tickets yet.</p>
{% endif %}

<!-- ========================================================= -->
<!-- LIVE SEARCH -->
<!-- ========================================================= -->
<script>
document.getElementById("search-input").addEventListener("keyup", function () {
    const q = this.value.trim();

    fetch("/accounts/live-search-tickets/?q=" + encodeURIComponent(q))
        .then(response => response.json())
        .then(data => {
            const grid = document.getElementById("ticket-grid");
            grid.innerHTML = "";

            if (data.tickets.length === 0) {
                grid.innerHTML = `
                    <p style="grid-column: 1 / -1; text-align:center;">
                        No tickets found.
                    </p>`;
                return;
            }

            data.tickets.forEach(tk => {

                let statusUI = "";

                if (tk.is_deleted && tk.is_expired) {
                    statusUI = `<div class="deleted-text">deleted & expired!</div>`;
                }
                else if (tk.is_deleted) {
                    statusUI = `<div class="deleted-text">This event has been deleted</div>`;
                }
                else if (tk.is_expired) {
                    statusUI = `<div class="expired-text">‚ùå Ticket has been expired!</div>`;
                }
                else if (tk.is_edited) {
                    statusUI = `<div class="edited-warning">‚ö† This event has been modified</div>`;
                }
                else {
                    statusUI = `<div class="blank-status-bar">This event is available</div>`;
                }

                // ‚≠ê Correct date format "Nov 28, 2026"
                let d = new Date(tk.event_date);
                let formattedDate = d.toLocaleDateString("en-US", { 
                    month: "short", 
                    day: "numeric", 
                    year: "numeric" 
                });

                let buttonHTML = "";

                // ‚≠ê SAME LOGIC AS ABOVE (search version)
                if (tk.is_expired) {
                    buttonHTML = `
                        <button class="delete-btn open-delete-modal expired-btn" 
                                data-ticket-id="${tk.id}">
                            Delete
                        </button>`;
                }
                else if (tk.is_deleted) {
                    buttonHTML = `
                        <button class="delete-btn open-delete-modal" 
                                data-ticket-id="${tk.id}">
                            Delete & Refund
                        </button>`;
                }
                else {
                    buttonHTML = `
                        <button class="delete-btn ticket-in-use-btn" disabled>
                            Ticket In Use!
                        </button>`;
                }

                grid.innerHTML += `
                    <div class="ticket-card ${tk.is_deleted ? "deleted" : ""}">
                        <h3>${tk.event_name}</h3>
                        ${statusUI}

                        <p><strong>Venue:</strong> ${tk.event_venue}</p>
                        <p><strong>Date:</strong> ${formattedDate}</p>
                        <p><strong>Time:</strong> ${tk.event_time_in} - ${tk.event_time_out}</p>
                        <p><strong>Price:</strong> ‚Ç±${tk.ticket_price}</p>

                        ${buttonHTML}
                    </div>
                `;
            });
        });
});
</script>

<!-- DELETE CONFIRMATION MODAL -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal-box">
        <h2>Are you sure you want to delete/refund this ticket?</h2>

        <div class="modal-buttons">
            <button id="cancelModalBtn" class="modal-btn modal-cancel">Cancel</button>
            <button id="confirmModalBtn" class="modal-btn modal-confirm">Confirm</button>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const modal = document.getElementById("confirmModal");
    const confirmBtn = document.getElementById("confirmModalBtn");
    const cancelBtn = document.getElementById("cancelModalBtn");

    let ticketToDelete = null;

    document.addEventListener("click", function(e) {
        if (e.target.classList.contains("open-delete-modal")) {
            ticketToDelete = e.target.dataset.ticketId;
            modal.style.display = "flex";
        }
    });

    cancelBtn.addEventListener("click", () => {
        modal.style.display = "none";
        ticketToDelete = null;
    });

    confirmBtn.addEventListener("click", () => {
        if (ticketToDelete) {
            window.location.href = `/accounts/delete-ticket/${ticketToDelete}/`;
        }
    });

});
</script>

</body>
</html>
