{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tickets</title>
    <link rel="stylesheet" href="{% static 'css/ticket_owned_styles.css' %}">
</head>
<body>

<!-- HEADER with Search -->
<div class="header">
    <h1>üéüÔ∏è My Tickets</h1>
    <a href="{% url 'accounts:home' %}" class="back-btn">‚¨Ö Back to Home</a>

    <!-- Search bar -->
    <div class="search-bar">
        <form method="get" action="">
            <input 
                type="text" 
                id="search-input" 
                name="q" 
                placeholder="Search your tickets..." 
                autocomplete="off"
            >
            <button type="submit">üîç</button>
        </form>
    </div>
</div>

{% if messages %}
<div class="messages">
    {% for message in messages %}
        <div class="message {{ message.tags }}">{{ message }}</div>
    {% endfor %}
</div>

<script>
setTimeout(() => {
    document.querySelectorAll('.message').forEach(msg => {
        msg.classList.add('fade-out');
        setTimeout(() => msg.remove(), 600);
    });
}, 5000);
</script>
{% endif %}

{% if tickets %}
<div class="ticket-grid" id="ticket-grid">
    {% for ticket in tickets %}
        <div class="ticket-card {% if ticket.event.is_deleted %}deleted{% endif %}">

            <h3>{{ ticket.event.event_name }}</h3>

            {% if ticket.event.is_deleted and ticket.is_expired %}
                <div class="deleted-text">This event deleted & expired!</div>

            {% elif ticket.event.is_deleted %}
                <div class="deleted-text">This event has been deleted</div>

            {% elif ticket.is_expired %}
                <div class="expired-text">‚ùå Ticket has been expired!</div>

            {% elif ticket.event.is_edited %}
                <div class="edited-warning">‚ö† This event has been modified</div>

            {% else %}
                <div class="blank-status-bar">This event is available</div>
            {% endif %}

            <p><strong>Venue:</strong> {{ ticket.event.event_venue }}</p>
            <p><strong>Date:</strong> {{ ticket.event.event_date }}</p>
            <p><strong>Time:</strong> {{ ticket.event.event_time_in }} - {{ ticket.event.event_time_out }}</p>
            <p><strong>Price:</strong> ‚Ç±{{ ticket.event.ticket_price }}</p>

            <!-- Delete button triggers modal -->
            <button type="button" 
                    class="delete-btn open-delete-modal {% if ticket.is_expired %}expired-btn{% endif %}" 
                    data-ticket-id="{{ ticket.id }}">
                {% if ticket.is_expired %}
                    Delete
                {% else %}
                    Delete & Refund
                {% endif %}
            </button>

        </div>
    {% endfor %}
</div>
{% else %}
<p class="no-tickets">You don‚Äôt own any tickets yet.</p>
{% endif %}

<!-- Live search -->
<script>
document.getElementById("search-input").addEventListener("keyup", function () {
    const q = this.value.trim();

    fetch("/accounts/live-search-tickets/?q=" + encodeURIComponent(q))
        .then(response => response.json())
        .then(data => {
            const grid = document.getElementById("ticket-grid");
            grid.innerHTML = "";

            if (data.tickets.length === 0) {
                grid.innerHTML = `
                    <p style="grid-column: 1 / -1; text-align:center;">
                        No tickets found.
                    </p>`;
                return;
            }

            data.tickets.forEach(tk => {

                let statusUI = "";

                if (tk.is_deleted && tk.is_expired) {
                    statusUI = `<div class="deleted-text">deleted & expired!</div>`;
                }
                else if (tk.is_deleted) {
                    statusUI = `<div class="deleted-text">This event has been deleted</div>`;
                }
                else if (tk.is_expired) {
                    statusUI = `<div class="expired-text">‚ùå Ticket has been expired!</div>`;
                }
                else if (tk.is_edited) {
                    statusUI = `<div class="edited-warning">‚ö† This event has been modified</div>`;
                }
                else {
                    statusUI = `<div class="blank-status-bar">This event is available</div>`;
                }

                grid.innerHTML += `
                    <div class="ticket-card ${tk.is_deleted ? "deleted" : ""}">
                        <h3>${tk.event_name}</h3>
                        ${statusUI}

                        <p><strong>Venue:</strong> ${tk.event_venue}</p>
                        <p><strong>Date:</strong> ${tk.event_date}</p>
                        <p><strong>Time:</strong> ${tk.event_time_in} - ${tk.event_time_out}</p>
                        <p><strong>Price:</strong> ‚Ç±${tk.ticket_price}</p>

                        <button type="button" 
                                class="delete-btn open-delete-modal ${tk.is_expired ? "expired-btn" : ""}"
                                data-ticket-id="${tk.id}">
                            ${tk.is_expired ? "Delete" : "Delete & Refund"}
                        </button>
                    </div>
                `;
            });
        });
});
</script>

<!-- =============================== -->
<!-- DELETE CONFIRMATION MODAL -->
<!-- =============================== -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal-box">
        <h2>Are you sure you want to delete/refund this ticket?</h2>

        <div class="modal-buttons">
            <button id="cancelModalBtn" class="modal-btn modal-cancel">Cancel</button>
            <button id="confirmModalBtn" class="modal-btn modal-confirm">Confirm</button>
        </div>
    </div>
</div>

<!-- =============================== -->
<!-- MODAL SCRIPT -->
<!-- =============================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {

    const modal = document.getElementById("confirmModal");
    const confirmBtn = document.getElementById("confirmModalBtn");
    const cancelBtn = document.getElementById("cancelModalBtn");

    let ticketToDelete = null;

    // OPEN modal
    document.querySelectorAll(".open-delete-modal").forEach(btn => {
        btn.addEventListener("click", () => {
            ticketToDelete = btn.dataset.ticketId;
            modal.style.display = "flex";
        });
    });

    // CANCEL modal
    cancelBtn.addEventListener("click", () => {
        modal.style.display = "none";
        ticketToDelete = null;
    });

    // CONFIRM delete
    confirmBtn.addEventListener("click", () => {
        if (ticketToDelete) {
            window.location.href = `/accounts/delete-ticket/${ticketToDelete}/`;
        }
    });

});
</script>

</body>
</html>
